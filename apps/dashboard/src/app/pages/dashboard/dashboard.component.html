<div class="min-h-screen bg-slate-50" data-testid="dashboard-page">
  <header class="bg-white shadow-sm">
    <div class="mx-auto flex max-w-6xl items-center justify-between px-6 py-4">
      <div>
        <h1 class="text-xl font-semibold text-slate-900">Task Management Dashboard</h1>
        <p class="text-sm text-slate-500">Secure tasks with RBAC and org scoping.</p>
      </div>
      <button
        class="text-sm text-slate-600 hover:text-slate-900"
        (click)="logout()"
        data-testid="sign-out"
      >
        Sign out
      </button>
    </div>
  </header>

  <main class="mx-auto max-w-6xl px-6 py-8 space-y-6">
    <section class="bg-white rounded-lg shadow-sm p-6" data-testid="task-form-section">
      <h2 class="text-lg font-semibold text-slate-900">Create / Edit Task</h2>
      <form
        class="mt-4 grid gap-4 md:grid-cols-2"
        [formGroup]="taskForm"
        (ngSubmit)="submitTask()"
        data-testid="task-form"
      >
        <div class="md:col-span-2">
          <label class="text-sm font-medium text-slate-700">Title</label>
          <input
            formControlName="title"
            class="mt-1 w-full rounded-md border border-slate-200 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-slate-500"
            data-testid="task-title"
          />
        </div>
        <div class="md:col-span-2">
          <label class="text-sm font-medium text-slate-700">Description</label>
          <textarea
            formControlName="description"
            rows="2"
            class="mt-1 w-full rounded-md border border-slate-200 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-slate-500"
            data-testid="task-description"
          ></textarea>
        </div>
        <div>
          <label class="text-sm font-medium text-slate-700">Category</label>
          <select
            formControlName="category"
            class="mt-1 w-full rounded-md border border-slate-200 px-3 py-2"
            data-testid="task-category"
          >
            <option *ngFor="let category of categories" [value]="category">
              {{ category }}
            </option>
          </select>
        </div>
        <div>
          <label class="text-sm font-medium text-slate-700">Status</label>
          <select
            formControlName="status"
            class="mt-1 w-full rounded-md border border-slate-200 px-3 py-2"
            data-testid="task-status"
          >
            <option *ngFor="let status of statuses" [value]="status">
              {{ status }}
            </option>
          </select>
        </div>
        <div class="md:col-span-2 flex gap-3">
          <button
            type="submit"
            class="rounded-md bg-slate-900 px-4 py-2 text-white hover:bg-slate-800"
            data-testid="task-save"
          >
            Save Task
          </button>
          <button
            type="button"
            class="rounded-md border border-slate-200 px-4 py-2 text-slate-700"
            (click)="taskForm.reset({ id: '', title: '', description: '', category: categories[0], status: statuses[0], order: 0 })"
            data-testid="task-clear"
          >
            Clear
          </button>
        </div>
      </form>
    </section>

    <section class="bg-white rounded-lg shadow-sm p-6" data-testid="task-filters">
      <div class="flex flex-wrap items-end gap-4" [formGroup]="filtersForm">
        <div>
          <label class="text-sm font-medium text-slate-700">Search</label>
          <input
            formControlName="search"
            class="mt-1 w-64 rounded-md border border-slate-200 px-3 py-2"
            placeholder="Search tasks"
            data-testid="filter-search"
          />
        </div>
        <div>
          <label class="text-sm font-medium text-slate-700">Category</label>
          <select
            class="mt-1 w-40 rounded-md border border-slate-200 px-3 py-2"
            formControlName="category"
            data-testid="filter-category"
          >
            <option value="">All</option>
            <option *ngFor="let category of categories" [value]="category">
              {{ category }}
            </option>
          </select>
        </div>
        <div>
          <label class="text-sm font-medium text-slate-700">Status</label>
          <select
            class="mt-1 w-40 rounded-md border border-slate-200 px-3 py-2"
            formControlName="status"
            data-testid="filter-status"
          >
            <option value="">All</option>
            <option *ngFor="let status of statuses" [value]="status">
              {{ status }}
            </option>
          </select>
        </div>
        <div>
          <label class="text-sm font-medium text-slate-700">Sort</label>
          <select
            class="mt-1 w-40 rounded-md border border-slate-200 px-3 py-2"
            formControlName="sort"
            data-testid="filter-sort"
          >
            <option *ngFor="let sort of sortOptions" [value]="sort">
              {{ sort }}
            </option>
          </select>
        </div>
        <div class="flex gap-2">
          <button
            class="rounded-md bg-slate-900 px-4 py-2 text-white hover:bg-slate-800"
            (click)="applyFilters()"
            data-testid="filter-apply"
          >
            Apply
          </button>
          <button
            class="rounded-md border border-slate-200 px-4 py-2 text-slate-700"
            (click)="clearFilters()"
            data-testid="filter-clear"
          >
            Clear
          </button>
        </div>
      </div>
    </section>

    <section class="grid gap-4 md:grid-cols-3" cdkDropListGroup data-testid="task-columns">
      <div
        *ngFor="let status of statuses"
        class="rounded-lg border border-slate-200 bg-white p-4 shadow-sm"
        [attr.data-testid]="'status-column-' + status"
      >
        <h3 class="text-sm font-semibold text-slate-700">{{ status }}</h3>
        <div
          cdkDropList
          [cdkDropListData]="getTasksByStatus(status)"
          (cdkDropListDropped)="drop($event, status)"
          class="mt-4 min-h-[120px] space-y-3"
        >
          <div
            *ngFor="let task of getTasksByStatus(status)"
            cdkDrag
            class="rounded-md border border-slate-200 bg-slate-50 p-3"
            data-testid="task-card"
            [attr.data-task-title]="task.title"
          >
            <div class="flex items-start justify-between">
              <div>
                <h4 class="font-medium text-slate-900">{{ task.title }}</h4>
                <p class="text-sm text-slate-500">{{ task.description }}</p>
              </div>
              <span class="text-xs rounded-full bg-slate-200 px-2 py-1">
                {{ task.category }}
              </span>
            </div>
            @if (authService.getUser()?.role !== 'Viewer') {
              <div class="mt-3 flex gap-2">
                <button
                  class="text-xs text-slate-600 hover:text-slate-900"
                  (click)="editTask(task)"
                  data-testid="task-edit"
                >
                  Edit
                </button>
                <button
                  class="text-xs text-rose-600 hover:text-rose-800"
                  (click)="deleteTask(task)"
                  data-testid="task-delete"
                >
                  Delete
                </button>
              </div>
            }
          </div>
        </div>
      </div>
    </section>
  </main>
</div>

<!-- Edit Modal -->
@if (showEditModal && taskToEdit) {
  <app-modal title="Edit Task" (close)="closeEditModal()">
    <form [formGroup]="taskForm" (ngSubmit)="confirmEdit()">
      <div class="space-y-4">
        <div>
          <label class="text-sm font-medium text-slate-700">Title *</label>
          <input
            formControlName="title"
            class="mt-1 w-full rounded-md border border-slate-200 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-slate-500"
          />
        </div>
        <div>
          <label class="text-sm font-medium text-slate-700">Description</label>
          <textarea
            formControlName="description"
            rows="3"
            class="mt-1 w-full rounded-md border border-slate-200 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-slate-500"
          ></textarea>
        </div>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="text-sm font-medium text-slate-700">Category</label>
            <select
              formControlName="category"
              class="mt-1 w-full rounded-md border border-slate-200 px-3 py-2"
            >
              <option *ngFor="let category of categories" [value]="category">
                {{ category }}
              </option>
            </select>
          </div>
          <div>
            <label class="text-sm font-medium text-slate-700">Status</label>
            <select
              formControlName="status"
              class="mt-1 w-full rounded-md border border-slate-200 px-3 py-2"
            >
              <option *ngFor="let status of statuses" [value]="status">
                {{ status }}
              </option>
            </select>
          </div>
        </div>
      </div>

      <div footer class="flex justify-end gap-3">
        <button
          type="button"
          (click)="closeEditModal()"
          class="px-4 py-2 text-sm font-medium text-slate-700 bg-white border border-slate-300 rounded-md hover:bg-slate-50"
        >
          Cancel
        </button>
        <button
          type="submit"
          [disabled]="taskForm.invalid"
          class="px-4 py-2 text-sm font-medium text-white bg-slate-900 rounded-md hover:bg-slate-800 disabled:bg-slate-400"
        >
          Save Changes
        </button>
      </div>
    </form>
  </app-modal>
}

<!-- Delete Confirmation Modal -->
@if (showDeleteModal && taskToDelete) {
  <app-confirmation-modal
    title="Delete Task"
    [message]="'Are you sure you want to delete ' + taskToDelete.title + '?'"
    [details]="'This action cannot be undone.'"
    confirmText="Delete"
    cancelText="Cancel"
    confirmType="danger"
    (confirm)="confirmDelete()"
    (cancel)="closeDeleteModal()"
  ></app-confirmation-modal>
}
