<div class="min-h-screen bg-slate-50 dark:bg-slate-950" data-testid="dashboard-page">
  <header class="bg-white shadow-sm dark:bg-slate-900">
    <div class="mx-auto flex max-w-6xl items-center justify-between px-6 py-4">
      <div>
        <h1 class="text-xl font-semibold text-slate-900 dark:text-slate-100">
          Task Management Dashboard
        </h1>
        <p class="text-sm text-slate-500 dark:text-slate-400">
          Secure tasks with RBAC and org scoping.
        </p>
      </div>
      <div class="flex items-center gap-4">
        <label class="flex items-center gap-2 text-sm text-slate-600 dark:text-slate-300">
          <span>{{ isDarkMode ? 'Dark' : 'Light' }}</span>
          <button
            type="button"
            class="relative inline-flex h-6 w-11 items-center rounded-full bg-slate-300 transition-colors dark:bg-slate-700"
            (click)="toggleTheme()"
            aria-label="Toggle theme"
          >
            <span
              class="inline-block h-5 w-5 translate-x-1 rounded-full bg-white shadow transition-transform dark:translate-x-5"
            ></span>
          </button>
        </label>
        <button
          class="text-sm text-slate-600 hover:text-slate-900 dark:text-slate-300 dark:hover:text-white"
          (click)="logout()"
          data-testid="sign-out"
        >
          Sign out
        </button>
      </div>
    </div>
  </header>

  <main class="mx-auto max-w-6xl px-6 py-8 space-y-6">
    <app-create-task-form
      [form]="taskForm"
      [categories]="categories"
      [statuses]="statuses"
      (submitTask)="submitTask()"
      (clearTask)="taskForm.reset({ id: '', title: '', description: '', category: categories[0], status: statuses[0], order: 0 })"
    ></app-create-task-form>

    <section
      class="rounded-lg bg-white p-6 shadow-sm dark:bg-slate-900"
      data-testid="task-filters"
    >
      <div class="flex flex-wrap items-end gap-4" [formGroup]="filtersForm">
        <div>
          <label class="text-sm font-medium text-slate-700 dark:text-slate-200">Search</label>
          <input
            formControlName="search"
            class="mt-1 w-64 rounded-md border border-slate-200 px-3 py-2 text-slate-900 dark:border-slate-700 dark:bg-slate-800 dark:text-slate-100"
            placeholder="Search tasks"
            data-testid="filter-search"
          />
        </div>
        <div>
          <label class="text-sm font-medium text-slate-700 dark:text-slate-200">Category</label>
          <select
            class="mt-1 w-40 rounded-md border border-slate-200 px-3 py-2 text-slate-900 dark:border-slate-700 dark:bg-slate-800 dark:text-slate-100"
            formControlName="category"
            data-testid="filter-category"
          >
            <option value="">All</option>
            <option *ngFor="let category of categories" [value]="category">
              {{ category }}
            </option>
          </select>
        </div>
        <div>
          <label class="text-sm font-medium text-slate-700 dark:text-slate-200">Status</label>
          <select
            class="mt-1 w-40 rounded-md border border-slate-200 px-3 py-2 text-slate-900 dark:border-slate-700 dark:bg-slate-800 dark:text-slate-100"
            formControlName="status"
            data-testid="filter-status"
          >
            <option value="">All</option>
            <option *ngFor="let status of statuses" [value]="status">
              {{ status }}
            </option>
          </select>
        </div>
        <div>
          <label class="text-sm font-medium text-slate-700 dark:text-slate-200">Sort</label>
          <select
            class="mt-1 w-40 rounded-md border border-slate-200 px-3 py-2 text-slate-900 dark:border-slate-700 dark:bg-slate-800 dark:text-slate-100"
            formControlName="sort"
            data-testid="filter-sort"
          >
            <option *ngFor="let sort of sortOptions" [value]="sort">
              {{ sort }}
            </option>
          </select>
        </div>
        <div class="flex gap-2">
          <button
            class="rounded-md bg-slate-900 px-4 py-2 text-white hover:bg-slate-800 dark:bg-slate-100 dark:text-slate-900 dark:hover:bg-slate-200"
            (click)="applyFilters()"
            data-testid="filter-apply"
          >
            Apply
          </button>
          <button
            class="rounded-md border border-slate-200 px-4 py-2 text-slate-700 dark:border-slate-700 dark:text-slate-200"
            (click)="clearFilters()"
            data-testid="filter-clear"
          >
            Clear
          </button>
        </div>
      </div>
    </section>

    <section class="grid gap-4 md:grid-cols-3" cdkDropListGroup data-testid="task-columns">
      <div
        *ngFor="let status of statuses"
        class="rounded-lg border border-slate-200 bg-white p-4 shadow-sm dark:border-slate-800 dark:bg-slate-900"
        [attr.data-testid]="'status-column-' + status"
      >
        <h3 class="text-sm font-semibold text-slate-700 dark:text-slate-200">{{ status }}</h3>
        <div
          cdkDropList
          [cdkDropListData]="getTasksByStatus(status)"
          (cdkDropListDropped)="drop($event, status)"
          class="mt-4 min-h-[120px] space-y-3"
        >
          <div
            *ngFor="let task of getTasksByStatus(status)"
            cdkDrag
            class="rounded-md border border-slate-200 bg-slate-50 p-3 dark:border-slate-800 dark:bg-slate-800"
            data-testid="task-card"
            [attr.data-task-title]="task.title"
          >
            <div class="flex items-start justify-between">
              <div>
                <h4 class="font-medium text-slate-900 dark:text-slate-100">{{ task.title }}</h4>
                <p class="text-sm text-slate-500 dark:text-slate-400">{{ task.description }}</p>
              </div>
              <span class="text-xs rounded-full bg-slate-200 px-2 py-1 dark:bg-slate-700 dark:text-slate-100">
                {{ task.category }}
              </span>
            </div>
            @if (authService.getUser()?.role !== 'Viewer') {
              <div class="mt-3 flex gap-2">
                <button
                  class="text-xs text-slate-600 hover:text-slate-900 dark:text-slate-300 dark:hover:text-white"
                  (click)="editTask(task)"
                  data-testid="task-edit"
                >
                  Edit
                </button>
                <button
                  class="text-xs text-rose-600 hover:text-rose-800 dark:text-rose-400 dark:hover:text-rose-300"
                  (click)="deleteTask(task)"
                  data-testid="task-delete"
                >
                  Delete
                </button>
              </div>
            }
          </div>
        </div>
      </div>
    </section>
  </main>
</div>

<!-- Edit Modal -->
@if (showEditModal && taskToEdit) {
  <app-modal title="Edit Task" (close)="closeEditModal()">
    <form [formGroup]="taskForm" (ngSubmit)="confirmEdit()">
      <div class="space-y-4">
        <div>
          <label class="text-sm font-medium text-slate-700">Title *</label>
          <input
            formControlName="title"
            class="mt-1 w-full rounded-md border border-slate-200 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-slate-500"
          />
        </div>
        <div>
          <label class="text-sm font-medium text-slate-700">Description</label>
          <textarea
            formControlName="description"
            rows="3"
            class="mt-1 w-full rounded-md border border-slate-200 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-slate-500"
          ></textarea>
        </div>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="text-sm font-medium text-slate-700">Category</label>
            <select
              formControlName="category"
              class="mt-1 w-full rounded-md border border-slate-200 px-3 py-2"
            >
              <option *ngFor="let category of categories" [value]="category">
                {{ category }}
              </option>
            </select>
          </div>
          <div>
            <label class="text-sm font-medium text-slate-700">Status</label>
            <select
              formControlName="status"
              class="mt-1 w-full rounded-md border border-slate-200 px-3 py-2"
            >
              <option *ngFor="let status of statuses" [value]="status">
                {{ status }}
              </option>
            </select>
          </div>
        </div>
      </div>

      <div footer class="flex justify-end gap-3">
        <button
          type="button"
          (click)="closeEditModal()"
          class="px-4 py-2 text-sm font-medium text-slate-700 bg-white border border-slate-300 rounded-md hover:bg-slate-50"
        >
          Cancel
        </button>
        <button
          type="submit"
          [disabled]="taskForm.invalid"
          class="px-4 py-2 text-sm font-medium text-white bg-slate-900 rounded-md hover:bg-slate-800 disabled:bg-slate-400"
        >
          Save Changes
        </button>
      </div>
    </form>
  </app-modal>
}

<!-- Delete Confirmation Modal -->
@if (showDeleteModal && taskToDelete) {
  <app-confirmation-modal
    title="Delete Task"
    [message]="'Are you sure you want to delete ' + taskToDelete.title + '?'"
    [details]="'This action cannot be undone.'"
    confirmText="Delete"
    cancelText="Cancel"
    confirmType="danger"
    (confirm)="confirmDelete()"
    (cancel)="closeDeleteModal()"
  ></app-confirmation-modal>
}
